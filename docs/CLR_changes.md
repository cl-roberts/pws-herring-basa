
# CLR's changes to PWS herring model repository

## Introduction

The Prince William Sound (PWS) Bayesian Age-Structured Stock Assessment (BASA) model for Pacific herring was developed in Dr. Trevor Branch's lab at the University of Washington beginning in 2014. BASA was adapted from an earlier excel-based least squares Age-Structured Assessment (ASA) used by the Alaska Department of Fish \& Game (ADF\&G) for stock assessment and management. Since BASA's development it has been used by students in Dr. Branch's lab for their graduate research and for conducting annual stock assessments. As of writing, these students were 

    - Melissa Muradian (MS 2015)
    - John Trochta (PhD 2021)
    - Joshua Zahner (MS 2023)

In 2022, Joshua Zahner trained CL Roberts (ADF\&G biometrician) in operation of BASA who subsequently forked a copy of the model for integration within ADF\&G's git systems. This document describes changes CLR has made to the model repository in granular detail.


## Changes

### Overview

No changes have been to the model structure. The ADMB code is exactly as it was provided to CLR. Consequently, the outputs generated by this BASA repository are in agreement with the original BASA repository found on Joshua Zahner's GitHub site (random noise associated with initial parameter values and MCMC sampling notwithstanding). All changes to model repository have been custodial thus far; they are detailed below and loosely fall within one of five categories: R package development, platform independence, documentation, repository structure, and automation.


### R package development

#### Motivation

The R codebase in the BASA repository consists of scripts and functions for reading in model data, feeding it to the ADMB code, writing important BASA outputs to .csv files, and generating plots of the results. Since BASA has changed hands several times over the years, the R codebase for interacting with the BASA model inputs and outputs has been rewritten and modified by the various student in Dr. Branch's lab. The result of this was the presence of some unused legacy code and, more importantly, redundant scripts that contained functions of the same names but with different behaviors. Thus, an internally inconsistent codebase could produce unexpected results or fail to execute depending on which scripts are sourced when.

An example: in the original copy of the BASA repository from which this repository was forked, there were many R functions located in a `functions` subdirectory. There were also R functions located at the top of plotting scripts located in the `plotting` subdirectory. In the `functions` subdirectory, there was a script (`fun_read_dat.R`) that had provided a function called `compute.catch.biomass()`. Another function called `compute.catch.biomass()` was created in the `plotting/compute_plot_products.R` script. These two functions were identical except for one took model data as an input and the other took a file path pointing to the model data as input. So when one wants to use this function to plot survey fits, for example, one has to source the correct script first or else the incorrect function will exist in the users global environment and their code will fail. 

To address the inconsistencies in the R codebase, CLR placed all of the R functions in a package named `pwsHerringBasa` that exists as a subdirectory in the main repository. The advantages to using an R package to house the model R functions include:

- namespace clashes between functions are avoided,
- functions now live in only one place rather than in multiple subdirectories,
- R functions are documented in `.rd` files,
- availability of code testing tools,  
- R package dependency management.

#### Package contents

So far, the `pwsHerringBasa` package only contains R functions and documentation. The R functions that were placed in the `pwsHerringBasa` package were all developed by graduate students in Dr. Branch's lab. CLR only made small modifications to the functions themselves - examples include sanity checking, explicitly specifying namespaces with the `::` operator (as required by `devtools` in package checks), adding comments, etc. The most important functions for executing the model are:

- `data.reader`,
- `init.admb.params`,
- `read.admb.files`, and
- `run.basa`.

After running the model, the most important functions for processing the results are 

- `compute.biomass.traj`,
- `compute.catch.biomass`,
- `compute.exploit.rate`,
- `compute.pfrb.posterior`,
- `compute.recruitment`, and
- `generate.post.pred`. Note that this referred to two different functions in the master branch. One generated posterior prediction intervals for multinomially-distributed age compositions, and the other generated posterior prediction intervals for lognormally (via `post.pred.lognorm()`) or negative-binomially (via `post.pred.negbin()`) distributed model fits to survey indices. CLR moved the former code into a new function called `post.pred.multinom()`, then generalized `generate.post.pred()` with `if` statements to call `post.pred.lognorm()`, `post.pred.negbin()` or `post.pred.multinom()` depending on the desired behavior.

Then, finally, the most important functions for plotting results are

- `plot_biomass_trajectory`,
- `plot_exploit_rate`,
- `plot_pfrb_posterior`,
- `plot_recruitment_posterior`, and
- `plot_survey_fits`.


### Platform independence

#### Shell commands

The behavior of shell commands for compiling the ADMB model may vary depending on the users operating system and, consequently, require slightly different R commands. The original BASA repository branch from which this repository was forked required the user to hardcode their operating system in a function found in `functions/run.basa.R` in order for the program to execute the correct shell commands compiling the model. Additionally, the model was only working for MacOS. After moving that script to the `pwsHerringBasa` package CLR added code such that the users operating system would be detected by the program, avoiding the necessity to hardcode it. Furthermore, code was added such that BASA could theoretically be run on a Linux system. **currently only windows is tested**

#### File paths

In addition to shell commands, file paths are handled differently by the `here` package between unix and windows systems. Specifically, if the last character typed into a filepath fed into `here::here()` is a forward slash, then that foreward slash is kept when executed in unix systems but dropped when executed in windows. That is, in unix `here::here(model/)` returns `path/to/model/` but returns `path/to/model` in windows. So to make BASA windows-compatible, CLR added a forward slash to all file paths throughout the repository that were constructed by concatenating `here::here()` strings to file names. These changes are all marked by comments and mostly lie within scripts in the `plotting` subdirectory; the inserted forward slashes should not affect the models ability to run on unix systems.  

### Documentation

#### R package `.rd` files

Every R function in the `pwsHerringBasa` package has an associated .rd file. These are documentation files which enable users to look up information and usage on what each function does. With the package loaded, simply use `?` or `help()` to read the function documentation.

#### 

### Repository structure

### Automation



## TMB model 

## 6/30/2025

- Fixed mortality covariate indexing and mortality forecast bugs in ADMB model

## 7/1/2025

- Fixed bug in estimation model for juvenile schools, now better fits
- Estimate `log_MeanAge0`, previously a fixed parameter (as is in ADMB model)
- Estimate age0 deviate for last year in model instead of fixing to 0
- Made age0 deviates random effects
- scaled age0 deviates by sigma_age0devs in attempt to decorrelate deviates
 
## 7/2/2025

- Added disease prevalence data from 2020-2024

## 7/3/2025

- undo treating age0 deviates as random effects in TMB model
- re-fix last deviate to 0


## 7/5/2025

- fixed divergences related to posfun in TMB model
- TMB bug fixes

## 7/6/2025

- TMB bug fixes

## 7/7/2025

- TMB bug fixes

## 7/9/2025

- implemented ESS calculation in TMB model
- implement report writing function in TMB model for debugging

## 7/10/2025

- fixed pound spawn removals calculation in first year of ADMB model (for calculating post-fishery spawning NAA) 
- fixed ignoring 7+ catches in first year of ADMB model
- fixed plus group bug (first five years) in TMB model 


## 7/11/2025

- fixed incrementation in first five years of age comp likelihood calculations in both ADMB and TMB models


## 7/23/2025

- fixed likelihood penalties applied by posfun in ADMB model
